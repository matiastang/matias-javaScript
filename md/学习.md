<!--
 * @Descripttion: 
 * @version: 
 * @Author: matias tang
 * @Date: 2020-09-25 15:54:57
 * @LastEditors: matias tang
 * @LastEditTime: 2020-09-25 18:10:37
-->
# 学习

[参考一](https://www.cnblogs.com/fundebug/p/differences-of-tcp-and-udp.html)
[深入理解TCP、UDP协议及两者的区别](https://blog.csdn.net/striveb/article/details/84063712)
[RTSP/RTP/RTCP](https://blog.csdn.net/niutianzhuang/article/details/80026243)
[RTMP]()

## 关于网络协议

QUIC、CDN、DNS

### 1、TCP和UDP二者的区别是什么？为什么说udp传输的性能比tcp要好，传输视频时，udp的延时要比tcp低？
![OSI](./images/OSI.png)
TCP/UDP区别
|	| UDP |	TCP |
| - | - | — |
|是否连接	|无连接	| 面向连接|
|是否可靠	|不可靠传输，不使用流量控制和拥塞控制|	可靠传输，使用流量控制和拥塞控制|
|连接对象个数	|支持一对一，一对多，多对一和多对多交互通信|	只能是一对一通信|
|传输方式	|面向报文	| 面向字节流|
|首部开销	|首部开销小，仅8字节 |	首部最小20字节，最大60字节|
|适用场景	|适用于实时应用（IP电话、视频会议、直播等）|	适用于要求可靠传输的应用，例如文件传输|

* TCP向上层提供面向连接的可靠服务 ，UDP向上层提供无连接不可靠服务。
* 虽然 UDP 并没有 TCP 传输来的准确，但是也能在很多实时性要求高的地方有所作为
* 对数据准确性要求高，速度可以相对较慢的，可以选用TCP

TCP和UDP的区别

TCP(传输控制协议)：

1)提供IP环境下的数据可靠传输(一台计算机发出的字节流会无差错的发往网络上的其他计算机，而且计算机A接收数据包的时候，也会向计算机B回发数据包，这也会产生部分通信量)，全双工操作(数据在两个方向上能同时传递)，多路复用服务，是面向连接，端到端的传输，提供超时重发，丢弃重复数据，检验数据，流量控制等功能

2)面向连接：正式通信前必须要与对方建立连接。事先为所发送的数据开辟出连接好的通道，然后再进行数据发送，像打电话。

3)TCP支持的应用协议：Telnet(远程登录)、FTP(文件传输协议)、SMTP(简单邮件传输协议)。TCP用于传输数据量大，可靠性要求高的应用。

UDP(用户数据报协议，User Data Protocol)

1)UDP是非连接的(正式通信前不必与对方建立连接，不管对方状态就直接发送，像短信，QQ。因而传输速度快)，不能提供可靠性、流控、超时重发功能。它是一个简单的面向数据报的运输层协议，只是把应用程序传给IP层的数据报发送出去，但是并不能保证它们能到达目的地。UDP用于一次只传送少量数据，可靠性要求低、传输经济等特点。

2) UDP支持的应用协议：NFS(网络文件系统)、SNMP(简单网络管理系统)、DNS(主域名称系统)、TFTP(通用文件传输协议)等。

总结：

TCP：面向连接、传输可靠(保证数据正确性,保证数据顺序)、用于传输大量数据(流模式)、速度慢，建立连接需要开销较多(时间，系统资源)。
UDP：面向非连接、传输不可靠、用于传输少量数据(数据包模式)、速度快。
联系：都是工作在传输层的协议

#### UDP构建可靠数据传输
简单来讲，要使用UDP来构建可靠的面向连接的数据传输，就要实现类似于TCP协议的 `超时重传`，`有序接受`，`应答确认`，`滑动窗口`、`流量控制`等机制，等于说要在传输层的上一层（或者直接在 应用层）实现TCP协议的可靠数据传输机制，比如使用 `UDP数据包+序列号`，`UDP数据包+时间戳`等方法， 在服务器端进行应答确认机制，这样就会保证不可靠的UDP协议进行可靠的数据传输，不过这好像也是一个难题！

UDP相对于TCP而言，是缺少一个可靠的丢失重发机制，因此可以立即返回，所以zhi你觉得快
UDP属于发射后不管，但是从IP层来说，它的效率和TCP相比，几乎相同
TCP为什么慢呢？就是因为需要 发射 确认 这样一个循环过程，所以慢
现在喜欢用UDP代替TCP的原因主要是 TCP的重发机制不完美，等待时间不合理，响应经常偏慢
UDP的问题主要在于丢包，如果你的API层协议规定部分数据可以丢失，那么UDP的响应速度会是最好的选择
同样，如果规定绝对不可以丢包，那么需要你自己在API或者引擎里负责处理UDP的可靠传输
一般测试下，在相对可靠的环境里，UDP的丢包率很低，因此即使采用确认模式传输，速度也很快

1，网速的提升给UDP稳定性提供可靠网络保障
CDN服务商Akamai（NASDAQ: AKAM）报告从2008年到2015年7年时间，各个国家网络平均速率由1.5Mbps提升为5.1Mbps，网速提升近4倍。网络环境变好，网络传输的延迟、稳定性也随之改善，UDP的丢包率低于5%，如果再使用应用层重传，能够完全确保传输的可靠性。

2，对比测试结果UDP性能优于TCP
为了提升浏览速度，Google基于TCP提出了SPDY协议以及HTTP/2。Google在Chrome上实验基于UDP的QUIC协议，传输速率减少到100ms以内。
Google采用QUIC后连接速率能有效提升75%。
Google搜索采用QUIC后页面加载性能提升3%。
YouTube采用QUIC后重新缓冲次数减少了30%。

3, TCP设计过于冗余，速度难以进一步提升
TCP为了实现网络通信的可靠性，使用了复杂的拥塞控制算法，建立了繁琐的握手过程以及重传策略。由于TCP内置在系统协议栈中，极难对其进行改进。

4, UDP协议以其简单、传输快的优势，在越来越多场景下取代了TCP
4.1 网页浏览
使用UDP协议有三个优点 ：

能够对握手过程进行精简，减少网络通信往返次数；
能够对TLS加解密过程进行优化；
收发快速，无阻塞。

4.2 流媒体
采用TCP，一旦发生丢包，TCP会将后续包缓存起来，等前面的包重传并接收到后再继续发送，延迟会越来越大。基于UDP的协议如WebRTC是极佳的选择。

2010年google 通过收购 Global IP Solutions，获得了WebRTC（网页实时通信，Web Real-Time Communication）技术，用于提升网页视频速率。

4.3 实时游戏
对实时要求较为严格的情况下，采用自定义的可靠UDP协议，比如Enet、RakNet（用户有sony online game、minecraft）等，自定义重传策略，能够把丢包产生的延迟降到最低，尽量减少网络问题对游戏性造成的影响。
采用UDP的经典游戏如FPS游戏Quake、CS，著名的游戏引擎Unity3D采用的也是RakNet。

4.4 物联网
2014年google旗下的Nest建立Thread Group，推出了物联网通信协议Thread，完善物联网通信。

#### 为什么说udp传输的性能比tcp要好，传输视频时，udp的延时要比tcp低？

视频图像传输有以下几个特点：1) `要求传输延时小，实时性高`； 2) `传输流量大，要求传输效率高`；3) `在一定程序上允许传输错误或数据丢失`。根据以上特点知，使用UDP协议来传输视频相对TCP协议更理想。

采用TCP，一旦发生丢包，TCP会将后续包缓存起来，等前面的包重传并接收到后再继续发送，延迟会越来越大。基于UDP的协议如WebRTC是极佳的选择。

微软 QUIC 库 -- MsQuic

UDP是User Datagram Protocol的简称，中文名是用户数据报协议，是OSI参考模型中一种无连接的传输层协议。正式通信前不必与对方先建立连接，直接向接收方发送数据，是一种不可靠的通信协议。正是由于UDP协议不关心网络数据传输的一系列状态，使得UDP协议在数据传输过程中节省了大量的`网络状态确认`和`数据确认`的系统资源消耗，大大提高UDP协议的传输效率，传输速度快。TCP(Transport ControlProtocol)协议是面向连接的传输协议,通信前需先建立连接，传输时延较大，TCP的确认和重发机制、流量控制机制虽能保证数据的可靠传输，但处理过程复杂，效率不高，对于音频和视频流，频繁的确认和重传无法保证数据的实时传送，所以相对不适合视频图像的传输。

### 2、如果做普通直播、互动直播和强互动的直播（比如网红直播打赏），你分别希望用那种协议？UDP还是TCP？为什么？

普通直播：TCP，直播对实时性要求不高，对清晰度、稳定性有要求。
互动直播和强互动的直播：UDP，对实时性要求高，交互需要做到延迟越低越好。基于 UDP 的私有协议与 RTMP 相比具有先天的优势，它是面向无连接的，避免了 TCP 做网络质量控制所需要的开销，能够做到比较低的延迟。
* UDP 的可靠性传输如丢包重传、网络抖动的处理
* 网路拥塞的控制算法
* 在全球节点的部署与智能调度
* 各种端的全面支持

HTS 支持广  延迟太高  10s
RTMP 延时性好，灵活   量大负载较高 1s
HTTP-FLV 延时性好，游戏直播常用   只能手机  2s以上

[HTTP3](https://mbd.baidu.com/newspage/data/landingshare?pageType=1&isBdboxFrom=1&context=%7B%22nid%22:%22news_9850460416286951242%22,%22sourceFrom%22:%22bjh%22%7D&_refluxos=i3)

## 移动端：
二、关于APP耗电的分析
1.在直面的开发过程中，上一个版本，没有问题；两周之后的当前版本，回归测试发现的问题： 原本一台手机，满电到没电，可以持续1个半小时；新版本只能持续1个小时了。
2.耗电比较常规的问题： 
a)GPS已经分析了，没有打开过。
b)网卡被唤醒： 因为直面是通讯类app，本身就会不断地用到网络收发。
c)Cpu和gpu之类占用高：因为通讯类app，编解码、网络、渲染美颜，这些都会很消耗cpu和gpu。看hotspot，看不出问题。
在这种情况下，你准备如何分析呢？

git/svn查看修改变动的模块，然后使用工具定位耗电增多的地方。

android： `battery historian`

官方建议优化的一些方法
https://developer.android.google.cn/training/monitoring-device-state/index.html

对低电耗模式和应用待机模式进行针对性优化
https://developer.android.google.cn/training/monitoring-device-state/doze-standby.html

Android 7.0新特性对电池管理进一步加强，一些新的变化可能多对我们现有的业务会造成影响需关注
https://developer.android.google.cn/about/versions/nougat/android-7.0-changes.html#perf

wake_lock 该属性是记录wake_lock模块的工作时间。是否有停止的时候等

iOS：先使用 Xcode Energy Gauge 分析出哪一块耗电（网络和 motion ， 还是定位 ... ）, 用 Time Profiler 定位问题与解决 （ Instruments 模版 ）, 得到用户好的反馈。
Xcode --> Open Developer Tool --> Instruments --> Energy Log
[iOS 电量消耗改善：一招套路及相关姿势](https://juejin.im/post/6844903725580943368)
[Instrument Time Profiler](https://juejin.im/post/6844903813262884877)
[iOS 性能优化 Instruments 检测 App 耗电量实战](https://www.jianshu.com/p/5e7ec80c9a27)

## PC或Linux：
二、 关于APP crash的分析：
在直面的开发过程中，上一个版本，没有问题；两周之后的当前版本，回归测试发现的问题： 程序会莫名其妙的crash，看crash的dmp文件，都是一些正常的语句出现的crash，估计是内存越界之类的问题。
在这种情况下，你准备如何分析呢？